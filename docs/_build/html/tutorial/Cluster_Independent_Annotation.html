<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CLUSTER INDEPENDENT ANNOTATION &mdash; CIA 0.0.post1.dev32+g0664b3a.d20220702 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="License" href="../license.html" />
    <link rel="prev" title="cia package" href="../modules_modified.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> CIA
          </a>
              <div class="version">
                0.0.post1.dev32+g0664b3a.d20220702
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules_modified.html">Documentation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial: CIA workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extracting-gene-signatures-from-pbmc-atlas">Extracting gene signatures from PBMC atlas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-dataset">Test dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signature-score">Signature score</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#raw-score">Raw score</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scaled-score">Scaled score</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#signature-based-classification">Signature-based classification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fast-classification">Fast classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fc-score-based-classification">FC score-based classification</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#standard-mode">Standard mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#quantile-based-filtering-mode">Quantile-based filtering mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#p-value-based-filtering-mode">p value-based filtering mode</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#classification-performance-evaluation">Classification performance evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conclusions">Conclusions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CIA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>CLUSTER INDEPENDENT ANNOTATION</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial/Cluster_Independent_Annotation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="cluster-independent-annotation">
<h1>CLUSTER INDEPENDENT ANNOTATION<a class="headerlink" href="#cluster-independent-annotation" title="Permalink to this headline"></a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p><strong>Cluster Independent Annotation</strong> (<strong>CIA</strong>) is a classification method
meant to <strong>help researchers in the cluster annotation step</strong> of
scRNA-seq experiments. Exploiting two functions, given cell type
signatures as input, <strong>this classifier computes a signature score for
each cell</strong> (<strong>signature_score</strong>) <strong>and</strong> (with different modalities)
<strong>it compares the score values in order to assign a label to each single
cell</strong> (<strong>signature_based_classification</strong>).</p>
<p>This tool provides several advantages:</p>
<ul class="simple">
<li><p>It synthesizes the information of <strong>a whole signature expression in a
single score value</strong>, skipping the tedious one by one inspection of
marker genes taken from long differentially expressed genes (DEGs)
lists, which furthermore may not be cluster specific when taken
singularly.</p></li>
<li><p>It provides a classification for each cell that is <strong>completely
independent from clustering</strong>, thus, it can be used in parallel with
a clustering method in order to set a proper resolution value,
obtaining so coherent and easy to annotate cell groups.</p></li>
<li><p>Given the implemented modalities, <strong>it can be very fast</strong> and
classify a huge dataset (hundreds of thousands cell) in a bunch of
seconds, <strong>or it can be statistically more reliable</strong> exploiting the
comparison of obtained signature scores with randomic signature ones.
Since the latter method is of course computationally heavier, <strong>we
implemented the possibility to parallelize processes</strong>.</p></li>
<li><p>Being signature-based, this tool can provide information about <strong>any
kind of gene list with a biological meaning</strong>, allowing also
functional annotation.</p></li>
<li><p>Normalizing for the gene signature length, it enables the
<strong>comparison of genesets with different length</strong>, spanning <strong>from
tens to thousands genes</strong> (obviously with different significance).</p></li>
</ul>
<p>CIA is composed by <strong>two main modules</strong>:</p>
<ul class="simple">
<li><p><strong>investigate</strong>: a module which contains the functions to <strong>compute
signature scores and automatically annotate cells accordingly</strong>
(functions: signature_score and signature_based_classification)</p></li>
<li><p><strong>report</strong>: a module which contains the functions to <strong>visualize
score distributions</strong> in cell groups <strong>and classification
performances</strong> with respect to a reference annotation (functions:
group_composition, classification_metrics,
grouped_classification_metrics and grouped_distributions)</p></li>
</ul>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">issparse</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">itertools</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cia</span> <span class="kn">import</span> <span class="n">investigate</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">utils</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline"></a></h2>
<p>In this tutorial is shown a <strong>representative workflow</strong> in which we
exploited CIA functions to <strong>automatically
annotate</strong><a class="reference external" href="https://scanpy.readthedocs.io/en/stable/generated/scanpy.datasets.pbmc3k.html">PBMC3K</a><strong>scRNA-seq
datasets</strong> at cellular level starting from a set of gene signatures
extracted from a <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0092867421005833">PBMC
atlas</a><strong>obained
with CITE-seq method</strong>.</p>
<div class="figure align-default" id="id1">
<img alt="datasets.png" src="tutorial/attachment:datasets.png" />
<p class="caption"><span class="caption-text">datasets.png</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</div>
<p>Our method requires as input an
<a class="reference external" href="https://anndata.readthedocs.io/en/latest/">AnnData</a> object with a
<strong>raw expression matrix</strong> (AnnData.raw.X) and a <strong>dictionary containing
the names of the signatures</strong> (e.g. cell type, cell state …) <strong>as keys
and correspondent gene names as values</strong>. With the intent of standardize
the analysis, <strong>we strongly suggest</strong> to use AnnData objects
preprocessed following those <a class="reference external" href="https://scanpy-tutorials.readthedocs.io/en/latest/pbmc3k.html">Scanpy
tutorial</a>
steps:</p>
<ul class="simple">
<li><p><strong>standard filtering</strong> on cells and genes.</p></li>
<li><p>setting <strong>normalized and logarithmized raw gene expression</strong> values
as .raw attribute.</p></li>
<li><p><strong>subsetting</strong> the AnnData with <strong>highly variable genes</strong>.</p></li>
</ul>
</div>
<div class="section" id="extracting-gene-signatures-from-pbmc-atlas">
<h2>Extracting gene signatures from PBMC atlas<a class="headerlink" href="#extracting-gene-signatures-from-pbmc-atlas" title="Permalink to this headline"></a></h2>
<p>For demonstration purposes, we decided to use as signatures the DEGs of
Hao et al 2021
<a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0092867421005833">[1]</a>
<strong>PBMC atlas</strong>. This dataset clusters have been <strong>confidently
annotated</strong> exploiting “weighted-nearest neighbor” framework, an
integrative analysis which takes into account both RNA and protein level
information. This approach ensures that the extracted gene lists (RNA
based only) are actually associated to a specific cell type.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to copy and gunzip the data</span>
<span class="o">!</span>cp ./data/atlas.h5ad.gz  ./data/copy_atlas.h5ad.gz
<span class="o">!</span>gunzip ./data/copy_atlas.h5ad.gz

<span class="c1"># to read the atlas data</span>
<span class="n">atlas</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;./data/copy_atlas.h5ad&#39;</span><span class="p">)</span>
<span class="n">atlas</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 161764 × 20729
    obs: &#39;nCount_ADT&#39;, &#39;nFeature_ADT&#39;, &#39;nCount_RNA&#39;, &#39;nFeature_RNA&#39;, &#39;orig.ident&#39;, &#39;lane&#39;, &#39;donor&#39;, &#39;time&#39;, &#39;celltype.l1&#39;, &#39;celltype.l2&#39;, &#39;celltype.l3&#39;, &#39;Phase&#39;, &#39;nCount_SCT&#39;, &#39;nFeature_SCT&#39;, &#39;Cell type&#39;
    var: &#39;features&#39;
    uns: &#39;celltype.l1_colors&#39;, &#39;celltype.l2_colors&#39;, &#39;celltype.l3_colors&#39;, &#39;neighbors&#39;
    obsm: &#39;X_apca&#39;, &#39;X_aumap&#39;, &#39;X_pca&#39;, &#39;X_spca&#39;, &#39;X_umap&#39;, &#39;X_wnn.umap&#39;
    varm: &#39;PCs&#39;, &#39;SPCA&#39;
    obsp: &#39;distances&#39;
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to remove the gunzipped data</span>
<span class="o">!</span>rm  ./data/copy_atlas.h5ad

<span class="c1"># to check if atlas.X is a count matrix</span>
<span class="n">atlas</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matrix</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to normalize the data</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">atlas</span><span class="p">)</span>

<span class="c1"># to set AnnData.raw attribute</span>
<span class="n">atlas</span><span class="o">.</span><span class="n">raw</span><span class="o">=</span> <span class="n">atlas</span>
</pre></div>
</div>
<p>This dataset has been annotated at <strong>3 different levels of
granularity</strong>. We focused on the coarser one, both for visualization
purposes and to facilitate the comparisons with other datasets annotated
at lower resolution.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;celltype.l1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_17_0.png" src="../_images/output_17_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">,</span> <span class="s1">&#39;celltype.l3&#39;</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_18_0.png" src="../_images/output_18_0.png" />
<p>Since labels <strong>‘other’ and ‘other T’</strong> don’t refer to any cell type in
particular, we checked their identity in the higher resolution
annotation.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">[(</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;gdT&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;MAIT&#39;</span><span class="p">)</span> <span class="o">|</span>
                 <span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;dnT&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Platelet&#39;</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_20_0.png" src="../_images/output_20_0.png" />
<p><strong>‘other T’</strong> cluster is composed by double negative T cells, gamma
delta T cells and MAIT cells. Those cells are <strong>not annotaded in
PBMC3K</strong>, therefore there is no way to determine wether their eventual
finding is correct or not. Since our intent is to use PBMC3K as test
dataset, <strong>we removed ‘other T’ cells from the analysis</strong>. <strong>‘other’</strong>
cluster is mainly composed by platelets and for this reason <strong>has been
renamed ‘Platelet’</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to remove &#39;other T&#39; cells</span>
<span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">[</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype.l1&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;other T&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype.l1&#39;</span><span class="p">]</span>
<span class="c1"># to rename clusters</span>
<span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">rename_categories</span><span class="p">([</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4 T&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 T&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;Mono&#39;</span><span class="p">,</span> <span class="s1">&#39;NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Platelet&#39;</span><span class="p">])</span>
<span class="n">atlas</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Cell type_colors&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">,</span> <span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span> <span class="s1">&#39;#8c564b&#39;</span><span class="p">,</span> <span class="s1">&#39;#e377c2&#39;</span><span class="p">]</span>
<span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
</pre></div>
</div>
<pre class="literal-block">Trying to set attribute <cite>.obs</cite> of view, copying.</pre>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4 T&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 T&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;Mono&#39;</span><span class="p">,</span> <span class="s1">&#39;NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Platelet&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We performed <strong>differential expression analysis</strong> (<strong>DEA</strong>) on coarser
resoluted clusters and we selected as DEGs genes having at least <strong>1.5
log2FC</strong>, with minimal <strong>mean of expression 0.25</strong>, <strong>z score 5</strong> and at
least <strong>expressed in 40% of cells</strong> within the cluster, in order to
obtain shorter but <strong>more specific gene lists</strong> than a usual DEA.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span> <span class="n">Default</span> <span class="n">of</span> <span class="n">the</span> <span class="n">method</span> <span class="n">has</span> <span class="n">been</span> <span class="n">changed</span> <span class="n">to</span> <span class="s1">&#39;t-test&#39;</span> <span class="kn">from</span> <span class="s1">&#39;t-test_overestim_var&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to filter differentially express genes with cia.utils.filter_degs()</span>
<span class="n">gmt</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_degs</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="n">uns_key</span><span class="o">=</span><span class="s1">&#39;rank_genes_groups&#39;</span><span class="p">,</span> <span class="n">logFC</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>  <span class="n">scores</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">perc</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                <span class="n">mean</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;up&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gmt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s1">&#39; signature has &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gmt</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span><span class="s1">&#39; genes&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">B</span> <span class="n">signature</span> <span class="n">has</span> <span class="mi">115</span> <span class="n">genes</span>
<span class="n">CD4</span> <span class="n">T</span> <span class="n">signature</span> <span class="n">has</span> <span class="mi">43</span> <span class="n">genes</span>
<span class="n">CD8</span> <span class="n">T</span> <span class="n">signature</span> <span class="n">has</span> <span class="mi">22</span> <span class="n">genes</span>
<span class="n">DC</span> <span class="n">signature</span> <span class="n">has</span> <span class="mi">156</span> <span class="n">genes</span>
<span class="n">Mono</span> <span class="n">signature</span> <span class="n">has</span> <span class="mi">674</span> <span class="n">genes</span>
<span class="n">NK</span> <span class="n">signature</span> <span class="n">has</span> <span class="mi">130</span> <span class="n">genes</span>
<span class="n">Platelet</span> <span class="n">signature</span> <span class="n">has</span> <span class="mi">132</span> <span class="n">genes</span>
</pre></div>
</div>
<p>We then assessed the overlap among lists and, <strong>despite the stringent
DEA</strong> , we found that <strong>CD8 T and CD4 T cells</strong> signatures show a
similarity that is remarkably higher than similarities among all the
other signatures (50% of DEGs shared with CD4 T). The authors themselves
claimed that those <strong>populations are difficult to be effectively
discriminated by scRNA-seq alone</strong>, in particular CD8 T and CD4 T cells.
Citing them <em>“We found that for CD8+ T cells, the most similar RNA
neighbors often reflected a mix of CD8+ and CD4+ T cells (in the RNA KNN
graph, there are a total of 944 incorrect edges that connect CD8+ to
CD4+ T cells). By contrast, protein neighbors were predominantly
correctly identified as CD8+ T cells (in the protein KNN graph, 12
CD8+/CD4+ edges were identified)”</em>
<a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0092867421005833">[1]</a>.
For this reason <strong>we can’t consider those signatures completely
specific</strong> and so <strong>we don’t expect to obtain an ideal classification
for those cell types</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to check gene lists similarity with cia.utils.signatures_similarity()</span>
<span class="n">utils</span><span class="o">.</span><span class="n">signatures_similarity</span><span class="p">(</span><span class="n">gmt</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B</th>
      <th>CD4 T</th>
      <th>CD8 T</th>
      <th>DC</th>
      <th>Mono</th>
      <th>NK</th>
      <th>Platelet</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B</th>
      <td>100.00</td>
      <td>2.33</td>
      <td>0.00</td>
      <td>15.38</td>
      <td>2.23</td>
      <td>0.77</td>
      <td>1.52</td>
    </tr>
    <tr>
      <th>CD4 T</th>
      <td>0.87</td>
      <td>100.00</td>
      <td>50.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>CD8 T</th>
      <td>0.00</td>
      <td>25.58</td>
      <td>100.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>3.85</td>
      <td>0.76</td>
    </tr>
    <tr>
      <th>DC</th>
      <td>20.87</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>100.00</td>
      <td>9.20</td>
      <td>1.54</td>
      <td>3.03</td>
    </tr>
    <tr>
      <th>Mono</th>
      <td>13.04</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>39.74</td>
      <td>100.00</td>
      <td>3.08</td>
      <td>16.67</td>
    </tr>
    <tr>
      <th>NK</th>
      <td>0.87</td>
      <td>0.00</td>
      <td>22.73</td>
      <td>1.28</td>
      <td>0.59</td>
      <td>100.00</td>
      <td>4.55</td>
    </tr>
    <tr>
      <th>Platelet</th>
      <td>1.74</td>
      <td>0.00</td>
      <td>4.55</td>
      <td>2.56</td>
      <td>3.26</td>
      <td>4.62</td>
      <td>100.00</td>
    </tr>
  </tbody>
</table>
</div><p>Since <strong>signature refinement is not the intent</strong> of this package and of
this tutorial, and <strong>it should be done before</strong> the
annotation/classification step, we proceeded using the above described
signatures to show the usages of the proposed functions, and to report
the automatic annotation performances.</p>
</div>
<div class="section" id="test-dataset">
<h2>Test dataset<a class="headerlink" href="#test-dataset" title="Permalink to this headline"></a></h2>
<p>In order <strong>to evaluate both the consistency</strong> of our method <strong>and the
performances of classification</strong>, <strong>we used</strong> the PMBC atlas <strong>DEGs to
automatically annotate</strong> the
<a class="reference external" href="https://scanpy.readthedocs.io/en/stable/generated/scanpy.datasets.pbmc3k.html">PBMC3K</a>
dataset from Satija et al. 2015
<a class="reference external" href="https://www.nature.com/articles/nbt.3192">[3]</a>. This dataset was
annotated by the authors relying on clustering and marker genes
expression inspection and it is widely used as reference in the
scientific community. <strong>We classified</strong> this dataset <strong>independently
from the already present annotation</strong>, whose <strong>cell labels were used as
ground truth</strong> to evaluate our classification perfomances with different
modalities.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to load the test dataset</span>
<span class="n">pbmc3k</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;data/pbmc3k.h5ad&#39;</span><span class="p">)</span>

<span class="c1"># to normalize and logarithmize the values</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">)</span>

<span class="c1"># to set the .raw attribute</span>
<span class="n">pbmc3k</span><span class="o">.</span><span class="n">raw</span><span class="o">=</span><span class="n">pbmc3k</span>

<span class="c1"># to compute HVG</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">min_mean</span><span class="o">=</span><span class="mf">0.0125</span><span class="p">,</span> <span class="n">max_mean</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_disp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># to subset features</span>
<span class="n">pbmc3k</span><span class="o">=</span><span class="n">pbmc3k</span><span class="p">[:,</span> <span class="n">pbmc3k</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">highly_variable</span><span class="p">]</span>
<span class="n">pbmc3k</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>View of AnnData object with n_obs × n_vars = 2638 × 1838
    obs: &#39;n_genes&#39;, &#39;percent_mito&#39;, &#39;n_counts&#39;, &#39;louvain&#39;, &#39;Cell type&#39;
    var: &#39;n_cells&#39;, &#39;highly_variable&#39;, &#39;means&#39;, &#39;dispersions&#39;, &#39;dispersions_norm&#39;
    uns: &#39;Cell type_colors&#39;, &#39;neighbors&#39;, &#39;log1p&#39;, &#39;hvg&#39;
    obsm: &#39;X_draw_graph_fr&#39;, &#39;X_pca&#39;, &#39;X_tsne&#39;, &#39;X_umap&#39;
    obsp: &#39;connectivities&#39;, &#39;distances&#39;
</pre></div>
</div>
<p>For the classification of the test dataset <strong>we renamed and merged some
clusters</strong> in order to make easier the comparison and the visualization
of results. In particular, ‘CD14+ Monocytes’ and ‘FCGR3A+ Monocytes’
clusters were merged into ‘Mono’.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;louvain&#39;</span><span class="p">,</span><span class="s1">&#39;Cell type&#39;</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">Trying to set attribute <cite>._uns</cite> of view, copying.</pre>
<img alt="../_images/output_34_1.png" src="../_images/output_34_1.png" />
</div>
<div class="section" id="signature-score">
<h2>Signature score<a class="headerlink" href="#signature-score" title="Permalink to this headline"></a></h2>
<p>signature_score function is <strong>based on “gene signature score”</strong>
calculation method shown in Della Chiara, Gervasoni, Fakiola, Godano et
al. 2021 <a class="reference external" href="https://www.nature.com/articles/s41467-021-22544-y">[2]</a>.</p>
<p>Given
<span class="math notranslate nohighlight">\({\bf{X}_{C}}=\{{X}_{1},{X}_{2},\ldots ,{X}_{n}\}:{X}_{i}&gt;0\)</span>, a
vector of positive gene expression values for cell <span class="math notranslate nohighlight">\({\bf{C}}\)</span>, and
given <span class="math notranslate nohighlight">\({\bf{S}}=\{{G}_{1},{G}_{2},\ldots ,{G}_{L}\}\)</span>, a list of
gene symbols of length <span class="math notranslate nohighlight">\({\bf{L}}\)</span>, the gene signature score of is
defined as:</p>
<p><span class="math notranslate nohighlight">\({\bf{GSS(C)}}=\frac{{n}}{L}\frac{{\sum }^L_{i=1}{\bf{X}}i}{{\sum}^n_{j=1}{\bf{X}j}}\)</span></p>
<p>With this score it is possible to <strong>condensate in a single value both
the proportion of expressed signature genes and their overall
expression</strong>, enabling researchers to easily study whole signatures
expression at single cell level.</p>
<div class="section" id="raw-score">
<h3>Raw score<a class="headerlink" href="#raw-score" title="Permalink to this headline"></a></h3>
<p>The raw score is the very same score described in the above mentioned
paper, it’s the <strong>default score_mode</strong> in signature_score function.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">investigate</span><span class="o">.</span><span class="n">signature_score</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">signatures_dict</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">score_mode</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="mi">14</span><span class="o">/</span><span class="mi">115</span> <span class="n">of</span> <span class="s2">&quot;B&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">3</span><span class="o">/</span><span class="mi">43</span> <span class="n">of</span> <span class="s2">&quot;CD4 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">2</span><span class="o">/</span><span class="mi">22</span> <span class="n">of</span> <span class="s2">&quot;CD8 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">5</span><span class="o">/</span><span class="mi">156</span> <span class="n">of</span> <span class="s2">&quot;DC&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">25</span><span class="o">/</span><span class="mi">674</span> <span class="n">of</span> <span class="s2">&quot;Mono&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">4</span><span class="o">/</span><span class="mi">130</span> <span class="n">of</span> <span class="s2">&quot;NK&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">9</span><span class="o">/</span><span class="mi">132</span> <span class="n">of</span> <span class="s2">&quot;Platelet&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">raw</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;B&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD8 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;DC&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Mono&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;NK&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Platelet&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
</pre></div>
</div>
<p><strong>Signature scores are stored by default in AnnData.obs</strong>, adding a
column for each signature named accordingly to the signature name.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">gmt</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B</th>
      <th>CD4 T</th>
      <th>CD8 T</th>
      <th>DC</th>
      <th>Mono</th>
      <th>NK</th>
      <th>Platelet</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAACATACAACCAC-1</th>
      <td>0.001613</td>
      <td>0.005325</td>
      <td>0.006661</td>
      <td>0.000675</td>
      <td>0.005526</td>
      <td>0.006314</td>
      <td>0.002356</td>
    </tr>
    <tr>
      <th>AAACATTGAGCTAC-1</th>
      <td>0.020164</td>
      <td>0.001019</td>
      <td>0.000489</td>
      <td>0.006552</td>
      <td>0.013895</td>
      <td>0.003540</td>
      <td>0.005919</td>
    </tr>
    <tr>
      <th>AAACATTGATCAGC-1</th>
      <td>0.000551</td>
      <td>0.010599</td>
      <td>0.002914</td>
      <td>0.000622</td>
      <td>0.008131</td>
      <td>0.003550</td>
      <td>0.004517</td>
    </tr>
    <tr>
      <th>AAACCGTGCTTCCG-1</th>
      <td>0.003013</td>
      <td>0.000082</td>
      <td>0.000165</td>
      <td>0.006363</td>
      <td>0.044171</td>
      <td>0.003155</td>
      <td>0.006048</td>
    </tr>
    <tr>
      <th>AAACCGTGTATGCG-1</th>
      <td>0.000454</td>
      <td>0.000392</td>
      <td>0.003250</td>
      <td>0.002069</td>
      <td>0.002695</td>
      <td>0.028752</td>
      <td>0.002484</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>TTTCGAACTCTCAT-1</th>
      <td>0.004509</td>
      <td>0.000066</td>
      <td>0.000132</td>
      <td>0.015625</td>
      <td>0.060052</td>
      <td>0.003075</td>
      <td>0.005499</td>
    </tr>
    <tr>
      <th>TTTCTACTGAGGCA-1</th>
      <td>0.006708</td>
      <td>0.001824</td>
      <td>0.000032</td>
      <td>0.002977</td>
      <td>0.010363</td>
      <td>0.002241</td>
      <td>0.004388</td>
    </tr>
    <tr>
      <th>TTTCTACTTCCTCG-1</th>
      <td>0.022383</td>
      <td>0.000654</td>
      <td>0.000000</td>
      <td>0.006210</td>
      <td>0.007250</td>
      <td>0.000737</td>
      <td>0.001222</td>
    </tr>
    <tr>
      <th>TTTGCATGAGAGGC-1</th>
      <td>0.015087</td>
      <td>0.000048</td>
      <td>0.000000</td>
      <td>0.004027</td>
      <td>0.005166</td>
      <td>0.001889</td>
      <td>0.001102</td>
    </tr>
    <tr>
      <th>TTTGCATGCCTCAC-1</th>
      <td>0.001351</td>
      <td>0.008759</td>
      <td>0.003322</td>
      <td>0.000776</td>
      <td>0.003832</td>
      <td>0.001040</td>
      <td>0.005636</td>
    </tr>
  </tbody>
</table>
<p>2638 rows × 7 columns</p>
</div><p>Alternatively, signature scores <strong>can be directly returned as an array</strong>
by specifying return_array=True.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">investigate</span><span class="o">.</span><span class="n">signature_score</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">signatures_dict</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">score_mode</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="n">return_array</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">14</span><span class="o">/</span><span class="mi">115</span> <span class="n">of</span> <span class="s2">&quot;B&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">3</span><span class="o">/</span><span class="mi">43</span> <span class="n">of</span> <span class="s2">&quot;CD4 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">2</span><span class="o">/</span><span class="mi">22</span> <span class="n">of</span> <span class="s2">&quot;CD8 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">5</span><span class="o">/</span><span class="mi">156</span> <span class="n">of</span> <span class="s2">&quot;DC&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">25</span><span class="o">/</span><span class="mi">674</span> <span class="n">of</span> <span class="s2">&quot;Mono&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">4</span><span class="o">/</span><span class="mi">130</span> <span class="n">of</span> <span class="s2">&quot;NK&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">9</span><span class="o">/</span><span class="mi">132</span> <span class="n">of</span> <span class="s2">&quot;Platelet&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">1.61271840e-03</span><span class="p">,</span> <span class="mf">5.32459784e-03</span><span class="p">,</span> <span class="mf">6.66090776e-03</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
        <span class="mf">5.52562313e-03</span><span class="p">,</span> <span class="mf">6.31357930e-03</span><span class="p">,</span> <span class="mf">2.35635833e-03</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">2.01640872e-02</span><span class="p">,</span> <span class="mf">1.01911682e-03</span><span class="p">,</span> <span class="mf">4.89214063e-04</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
        <span class="mf">1.38954993e-02</span><span class="p">,</span> <span class="mf">3.54014299e-03</span><span class="p">,</span> <span class="mf">5.91941593e-03</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">5.50757633e-04</span><span class="p">,</span> <span class="mf">1.05985086e-02</span><span class="p">,</span> <span class="mf">2.91369013e-03</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
        <span class="mf">8.13105374e-03</span><span class="p">,</span> <span class="mf">3.54984899e-03</span><span class="p">,</span> <span class="mf">4.51662991e-03</span><span class="p">],</span>
       <span class="o">...</span><span class="p">,</span>
       <span class="p">[</span><span class="mf">2.23828926e-02</span><span class="p">,</span> <span class="mf">6.53903419e-04</span><span class="p">,</span> <span class="mf">0.00000000e+00</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
        <span class="mf">7.25031163e-03</span><span class="p">,</span> <span class="mf">7.37115031e-04</span><span class="p">,</span> <span class="mf">1.22186735e-03</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">1.50866892e-02</span><span class="p">,</span> <span class="mf">4.79971059e-05</span><span class="p">,</span> <span class="mf">0.00000000e+00</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
        <span class="mf">5.16614134e-03</span><span class="p">,</span> <span class="mf">1.88920512e-03</span><span class="p">,</span> <span class="mf">1.10187375e-03</span><span class="p">],</span>
       <span class="p">[</span><span class="mf">1.35067629e-03</span><span class="p">,</span> <span class="mf">8.75875577e-03</span><span class="p">,</span> <span class="mf">3.32235992e-03</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
        <span class="mf">3.83193033e-03</span><span class="p">,</span> <span class="mf">1.04008169e-03</span><span class="p">,</span> <span class="mf">5.63590560e-03</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="section" id="scaled-score">
<h3>Scaled score<a class="headerlink" href="#scaled-score" title="Permalink to this headline"></a></h3>
<p>Scaled score is the <strong>raw score divided by max score value</strong> for that
given signature, operation which rescales the values from 0 to 1. Scaled
scores of <strong>different signatures</strong>, with <strong>different length</strong>, can thus
be <strong>directly compared</strong>. To compute the ‘scaled’ score, score_mode must
be set as ‘scaled’.</p>
<p>To assess the capability of extracted signatures to discriminate cell
types, we compared scaled score distributions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">investigate</span><span class="o">.</span><span class="n">signature_score</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">signatures_dict</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">score_mode</span><span class="o">=</span><span class="s1">&#39;scaled&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="n">All</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">scaled</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;B&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD8 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;DC&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Mono&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;NK&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Platelet&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_49_0.png" src="../_images/output_49_0.png" />
<p>By inspecting the score values, for all the signatures, <strong>the highest
values are found in the proper cluster</strong>, indicating the sensitivity of
the signatures and the capability of the signature score to represent
the expression of the whole gene lists.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">gmt</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">color_map</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_51_0.png" src="../_images/output_51_0.png" />
<p><strong>CD4 T and CD8 T scores</strong>, as expected, <strong>show an overlap reflecting
their similarity</strong>. In particular <strong>both</strong> signatures are <strong>highly
expressed in CD8 naive subcluster</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">atlas</span><span class="p">[(</span><span class="n">atlas</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CD8 Naive&#39;</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;celltype.l2&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_53_0.png" src="../_images/output_53_0.png" />
<p>Inspecting the violin plots showing the <strong>distribution of score
values</strong>, as expected, it seems that <strong>there is a cluster in which
values are higher than all the others</strong> for each signature.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">violin</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">gmt</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_55_0.png" src="../_images/output_55_0.png" />
<p>To better viusualize those distributions, we exploited
<strong>grouped_distributions</strong>. By selecting AnnData.obs columns containing
<strong>signature scores</strong>, this function plots <strong>a heatmap showing the
medians of their values in cell groups</strong> (each of the above shown violin
plot information is condensed in a heatmap column) and it prints <strong>a
statistical report</strong>. <strong>For each cell group</strong>, a two-sided <strong>Wilcoxon
test</strong> is perfomed to evaluate if the distribution with the highest
median is different from the others. <strong>For each signature</strong>, a two-sided
<strong>Mann-Whitney U test</strong> is performed to evaluate if the distribution in
the cell group having the highest median is different from the other
groups distributions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">grouped_distributions</span><span class="p">(</span><span class="n">atlas</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="n">columns_obs</span><span class="o">=</span><span class="n">gmt</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">scale_medians</span><span class="o">=</span><span class="s1">&#39;column-wise&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performing</span> <span class="n">Wilcoxon</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">distribution</span> <span class="n">significantly</span> <span class="n">higher</span> <span class="n">than</span> <span class="n">the</span> <span class="n">others</span> <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">Performing</span> <span class="n">Mann</span><span class="o">-</span><span class="n">Whitney</span> <span class="n">U</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">selected</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span> <span class="n">column</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">a</span> <span class="n">cell</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">values</span> <span class="n">are</span> <span class="n">higher</span> <span class="k">with</span> <span class="n">respect</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">other</span> <span class="n">groups</span>  <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_57_1.png" src="../_images/output_57_1.png" />
<p>The statistical tests confirmed that the <strong>visible differences in
signature score distributions are significant</strong>, indicating that scaled
signature scores are consistent with authors annotation. With the
evidence of the goodness of the signatures, we proceeded with the
classification of PBMC3K.</p>
</div>
</div>
<div class="section" id="signature-based-classification">
<h2>Signature-based classification<a class="headerlink" href="#signature-based-classification" title="Permalink to this headline"></a></h2>
<p>To classify the test dataset we used <strong>signature_based_classification</strong>.
<strong>Two</strong> main classification <strong>modalities</strong> have been implemented: a
<strong>fast classification mode</strong>, in which scaled scores are directly
computed and compared, and a <strong>FC score-based mode</strong> that, relying on
the comparison between raw signature scores and randomic signature
scores, can provide a more confident classification at the cost of
computation time.</p>
<div class="section" id="fast-classification">
<h3>Fast classification<a class="headerlink" href="#fast-classification" title="Permalink to this headline"></a></h3>
<p>Fast classification is performed by <strong>assigning to each cell the label
of the signature with the max scaled score value</strong>. Being based on
matrices and vectors operations, this computation is <strong>very fast</strong> (the
161764 cells of the PBMC atlas were classified with the high-performance
computing server infrastructure of our institute in nearby 22s).</p>
<p><strong>To counteract the transcriptional similarity</strong> between CD4 T and CD8 T
cells <strong>we used the population-defining key genes expression as negative
markers</strong> (CD8A and CD8B for CD4 T cells; CD4 for CD8 T cells).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CD8 T&#39;</span><span class="p">:[</span><span class="s1">&#39;CD4&#39;</span><span class="p">],</span> <span class="s1">&#39;CD4 T&#39;</span><span class="p">:[</span><span class="s1">&#39;CD8A&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8B&#39;</span><span class="p">]}</span>
</pre></div>
</div>
<p>By assigning neg dictionary to negative_markers paramaters, <strong>a scaled
score is computed</strong> for both CD8 T and CD4 T negative markers,
<strong>inverted</strong> (score= 1-score) and <strong>multiplied by corresponding
signature values</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">investigate</span><span class="o">.</span><span class="n">signature_based_classification</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">signatures_dict</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">negative_markers</span><span class="o">=</span><span class="n">neg</span><span class="p">,</span>
                                           <span class="n">fast_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">obs_name</span><span class="o">=</span><span class="s1">&#39;Prediction fast mode&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">14</span><span class="o">/</span><span class="mi">115</span> <span class="n">of</span> <span class="s2">&quot;B&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">3</span><span class="o">/</span><span class="mi">43</span> <span class="n">of</span> <span class="s2">&quot;CD4 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">2</span><span class="o">/</span><span class="mi">22</span> <span class="n">of</span> <span class="s2">&quot;CD8 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">5</span><span class="o">/</span><span class="mi">156</span> <span class="n">of</span> <span class="s2">&quot;DC&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">25</span><span class="o">/</span><span class="mi">674</span> <span class="n">of</span> <span class="s2">&quot;Mono&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">4</span><span class="o">/</span><span class="mi">130</span> <span class="n">of</span> <span class="s2">&quot;NK&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">9</span><span class="o">/</span><span class="mi">132</span> <span class="n">of</span> <span class="s2">&quot;Platelet&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="n">All</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">scaled</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;CD8 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>

<span class="n">Classification</span> <span class="n">labels</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Prediction fast mode&quot;</span><span class="p">]</span>

<span class="n">Runtime</span> <span class="n">of</span> <span class="n">the</span> <span class="n">process</span> <span class="ow">is</span> <span class="mf">0.32</span> <span class="n">s</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Fast classification complete!&#39;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="n">storing</span> <span class="s1">&#39;Prediction fast mode&#39;</span> <span class="k">as</span> <span class="n">categorical</span>
</pre></div>
</div>
<img alt="../_images/output_67_1.png" src="../_images/output_67_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">grouped_distributions</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="n">columns_obs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD4 T&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 T&#39;</span><span class="p">,</span> <span class="s1">&#39;NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Mono&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;Platelet&#39;</span><span class="p">],</span> <span class="n">scale_medians</span><span class="o">=</span><span class="s1">&#39;column-wise&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performing</span> <span class="n">Wilcoxon</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="o">...</span>
<span class="n">WARNING</span> <span class="ow">in</span> <span class="n">cell</span> <span class="n">group</span> <span class="n">DC</span><span class="p">:</span> <span class="n">DC</span> <span class="n">values</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">significantly</span> <span class="n">different</span> <span class="kn">from</span> <span class="nn">Mono</span> <span class="n">values</span><span class="o">.</span>

<span class="n">Performing</span> <span class="n">Mann</span><span class="o">-</span><span class="n">Whitney</span> <span class="n">U</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">selected</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span> <span class="n">column</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">a</span> <span class="n">cell</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">values</span> <span class="n">are</span> <span class="n">higher</span> <span class="k">with</span> <span class="n">respect</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">other</span> <span class="n">groups</span>  <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_68_1.png" src="../_images/output_68_1.png" />
<p><strong>Also for PBMC3K</strong>, for each signature, <strong>there is a cluster in which
scores are significantly higher than all the others</strong>. This confirmed
the consistency of the signatures across datasets and suggested that the
<strong>scaled score could be per se sufficient to help researchers in an
eventual annotation</strong>, permitting to <strong>skip the one-by-one evaluation</strong>
of DEGs reported in literature as marker genes.</p>
<p>By inspecting and comparing the ground truth and the predicted labels is
evident that <strong>the vast majority of the cells was correctly
classified</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Prediction fast mode_colors&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">,</span> <span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span> <span class="s1">&#39;#8c564b&#39;</span><span class="p">,</span> <span class="s1">&#39;#e377c2&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span><span class="s1">&#39;Prediction fast mode&#39;</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_72_0.png" src="../_images/output_72_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">group_composition</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">classification_obs</span><span class="o">=</span><span class="s1">&#39;Prediction fast mode&#39;</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span>
                  <span class="n">columns_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD4 T&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 T&#39;</span><span class="p">,</span> <span class="s1">&#39;NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Mono&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;Platelet&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_73_0.png" src="../_images/output_73_0.png" />
</div>
<div class="section" id="fc-score-based-classification">
<h3>FC score-based classification<a class="headerlink" href="#fc-score-based-classification" title="Permalink to this headline"></a></h3>
<p>FC score-based classification is performed by <strong>looking for the max Fold
Change score value for each cell instead of scaled score one</strong>. FC score
is computed by dividing the raw signatue score by the median of raw
scores of a given number (n_iter) of <strong>randomic signatures</strong>. To
generate randomic signatures, all genes of the dataset are ranked by
their mean expression and are assigned to a given bin, and <strong>for each
signature gene a randomic gene of the same expression bin is taken</strong>.</p>
<div class="section" id="standard-mode">
<h4>Standard mode<a class="headerlink" href="#standard-mode" title="Permalink to this headline"></a></h4>
<p>Standard mode is performed with default parameters: all the <strong>FC scores
lower than 1 (randomic score &lt; signature score) are turned into 0</strong>, and
if a cell has a FC score equal to 0 for all the signature it will not be
assigned to any cell type. This approach is slower with respect to fast
mode and it could be affected by a <strong>decrease of performances due to
unassigned cells, but in this way the classified cells are labelled with
an higher confidence</strong> and cells with low FCs (e.g. not fully
differentiated) are not forced to be classified. To speed-up the process
<strong>it’s possible to parallelize</strong> the computations allocating jobs to a
given number of processors (n_proc). By setting <strong>new_score=‘FC’</strong>,
<strong>raw scores in AnnData.obs can be replaced by FC values</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">investigate</span><span class="o">.</span><span class="n">signature_based_classification</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">signatures_dict</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">negative_markers</span><span class="o">=</span><span class="n">neg</span><span class="p">,</span>
                    <span class="n">n_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">new_score</span><span class="o">=</span><span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="n">obs_name</span><span class="o">=</span><span class="s1">&#39;Prediction standard mode&#39;</span><span class="p">,</span> <span class="n">FC_threshold</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="mi">14</span><span class="o">/</span><span class="mi">115</span> <span class="n">of</span> <span class="s2">&quot;B&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">3</span><span class="o">/</span><span class="mi">43</span> <span class="n">of</span> <span class="s2">&quot;CD4 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">2</span><span class="o">/</span><span class="mi">22</span> <span class="n">of</span> <span class="s2">&quot;CD8 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">5</span><span class="o">/</span><span class="mi">156</span> <span class="n">of</span> <span class="s2">&quot;DC&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">25</span><span class="o">/</span><span class="mi">674</span> <span class="n">of</span> <span class="s2">&quot;Mono&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">4</span><span class="o">/</span><span class="mi">130</span> <span class="n">of</span> <span class="s2">&quot;NK&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">9</span><span class="o">/</span><span class="mi">132</span> <span class="n">of</span> <span class="s2">&quot;Platelet&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">raw</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;B&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD8 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;DC&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Mono&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;NK&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Platelet&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>

<span class="n">raw</span> <span class="n">scores</span> <span class="n">are</span> <span class="n">being</span> <span class="n">replaced</span> <span class="n">by</span> <span class="n">Fold</span> <span class="n">Change</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="n">All</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">scaled</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;CD8 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>

<span class="n">Classification</span> <span class="n">labels</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Prediction standard mode&quot;</span><span class="p">]</span>

<span class="n">Results</span> <span class="n">have</span> <span class="n">been</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;signature_based_classification&quot;</span><span class="p">]</span>

<span class="n">Runtime</span> <span class="n">of</span> <span class="n">the</span> <span class="n">process</span> <span class="ow">is</span> <span class="mf">6.33</span> <span class="nb">min</span> <span class="k">with</span> <span class="mi">32</span> <span class="n">cores</span>
</pre></div>
</div>
<p>Beside the possibility to substitute raw score values in AnnData.obs, by
default <strong>both FC scores and filtered FC scores are stored in
AnnData.uns</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">=</span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;signature_based_classification&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
<span class="n">pbmc3k</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">=</span><span class="n">df</span>
<span class="n">df</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B_filtered_FC</th>
      <th>CD4 T_filtered_FC</th>
      <th>CD8 T_filtered_FC</th>
      <th>DC_filtered_FC</th>
      <th>Mono_filtered_FC</th>
      <th>NK_filtered_FC</th>
      <th>Platelet_filtered_FC</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAACATACAACCAC-1</th>
      <td>0.000000</td>
      <td>1.124789</td>
      <td>4.570688</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.974376</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>AAACATTGAGCTAC-1</th>
      <td>8.587371</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.184307</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.275801</td>
    </tr>
    <tr>
      <th>AAACATTGATCAGC-1</th>
      <td>0.000000</td>
      <td>3.751404</td>
      <td>1.300559</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.250395</td>
    </tr>
    <tr>
      <th>AAACCGTGCTTCCG-1</th>
      <td>1.054793</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.191148</td>
      <td>4.376160</td>
      <td>0.000000</td>
      <td>1.175615</td>
    </tr>
    <tr>
      <th>AAACCGTGTATGCG-1</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.333642</td>
      <td>1.637132</td>
      <td>0.000000</td>
      <td>14.788568</td>
      <td>1.143168</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>TTTCGAACTCTCAT-1</th>
      <td>1.252642</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>4.103183</td>
      <td>4.395255</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>TTTCTACTGAGGCA-1</th>
      <td>3.959939</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.430574</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.403503</td>
    </tr>
    <tr>
      <th>TTTCTACTTCCTCG-1</th>
      <td>26.878841</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>4.985177</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>TTTGCATGAGAGGC-1</th>
      <td>15.592578</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.928368</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>TTTGCATGCCTCAC-1</th>
      <td>0.000000</td>
      <td>5.751529</td>
      <td>2.344116</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.392587</td>
    </tr>
  </tbody>
</table>
<p>2638 rows × 7 columns</p>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filtered_FC_pbmc3k</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD4 T_filtered_FC&#39;</span><span class="p">,</span><span class="s1">&#39;B_filtered_FC&#39;</span><span class="p">,</span><span class="s1">&#39;CD8 T_filtered_FC&#39;</span><span class="p">,</span><span class="s1">&#39;NK_filtered_FC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Mono_filtered_FC&#39;</span><span class="p">,</span><span class="s1">&#39;DC_filtered_FC&#39;</span><span class="p">,</span><span class="s1">&#39;Platelet_filtered_FC&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>By inspecting the distributions of <strong>filtered FC scores</strong>, it is even
more evident that <strong>each signature is preferentially expressed by one
cell group</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">grouped_distributions</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">columns_obs</span><span class="o">=</span><span class="n">filtered_FC_pbmc3k</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span>
                             <span class="n">scale_medians</span><span class="o">=</span><span class="s1">&#39;column-wise&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performing</span> <span class="n">Wilcoxon</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">distribution</span> <span class="n">significantly</span> <span class="n">higher</span> <span class="n">than</span> <span class="n">the</span> <span class="n">others</span> <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">Performing</span> <span class="n">Mann</span><span class="o">-</span><span class="n">Whitney</span> <span class="n">U</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">selected</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span> <span class="n">column</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">a</span> <span class="n">cell</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">values</span> <span class="n">are</span> <span class="n">higher</span> <span class="k">with</span> <span class="n">respect</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">other</span> <span class="n">groups</span>  <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_83_1.png" src="../_images/output_83_1.png" />
<p>Indeed, the majority of each cell group has been <strong>correctly
classified</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Prediction standard mode_colors&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span><span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span><span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span><span class="s1">&#39;#d62728&#39;</span><span class="p">,</span><span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span><span class="s1">&#39;#8c564b&#39;</span><span class="p">,</span><span class="s1">&#39;#e377c2&#39;</span><span class="p">,</span><span class="s1">&#39;#bcbd22&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="s1">&#39;Prediction standard mode&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="n">storing</span> <span class="s1">&#39;Prediction standard mode&#39;</span> <span class="k">as</span> <span class="n">categorical</span>
</pre></div>
</div>
<img alt="../_images/output_86_1.png" src="../_images/output_86_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">group_composition</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">classification_obs</span><span class="o">=</span><span class="s1">&#39;Prediction standard mode&#39;</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span>
                  <span class="n">columns_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD4 T&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 T&#39;</span><span class="p">,</span> <span class="s1">&#39;NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Mono&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;Platelet&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_87_0.png" src="../_images/output_87_0.png" />
<p><strong>No major differences have been detected</strong> between fast and standard
classification in both datasets, suggesting a per se validity of scaled
score to perform a fast explorative cell type prediction.</p>
</div>
<div class="section" id="quantile-based-filtering-mode">
<h4>Quantile-based filtering mode<a class="headerlink" href="#quantile-based-filtering-mode" title="Permalink to this headline"></a></h4>
<p><strong>Quantile-based filter adds another layer of stringency</strong> to the
classification by acting on FC distributions. By setting q equal to a
number from 0 to 1, all the FC score values below that given quantile
are set 0. In this way <strong>only the highest values of FC are mainteined
and so only the most signature-expressing cells will be classified</strong>.
This could be very useful in case of bimodal distribution of score
values or when a signature is moderately expressed in all the clusters.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">investigate</span><span class="o">.</span><span class="n">signature_based_classification</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">signatures_dict</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">negative_markers</span><span class="o">=</span><span class="n">neg</span><span class="p">,</span>
                    <span class="n">n_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">obs_name</span><span class="o">=</span><span class="s1">&#39;Prediction q&#39;</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="mi">14</span><span class="o">/</span><span class="mi">115</span> <span class="n">of</span> <span class="s2">&quot;B&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">3</span><span class="o">/</span><span class="mi">43</span> <span class="n">of</span> <span class="s2">&quot;CD4 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">2</span><span class="o">/</span><span class="mi">22</span> <span class="n">of</span> <span class="s2">&quot;CD8 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">5</span><span class="o">/</span><span class="mi">156</span> <span class="n">of</span> <span class="s2">&quot;DC&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">25</span><span class="o">/</span><span class="mi">674</span> <span class="n">of</span> <span class="s2">&quot;Mono&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">4</span><span class="o">/</span><span class="mi">130</span> <span class="n">of</span> <span class="s2">&quot;NK&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">9</span><span class="o">/</span><span class="mi">132</span> <span class="n">of</span> <span class="s2">&quot;Platelet&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">raw</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;B&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD8 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;DC&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Mono&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;NK&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Platelet&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="n">All</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">scaled</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;CD8 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>

<span class="n">Classification</span> <span class="n">labels</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Prediction q&quot;</span><span class="p">]</span>

<span class="n">Results</span> <span class="n">have</span> <span class="n">been</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;signature_based_classification&quot;</span><span class="p">]</span>

<span class="n">Runtime</span> <span class="n">of</span> <span class="n">the</span> <span class="n">process</span> <span class="ow">is</span> <span class="mf">6.37</span> <span class="nb">min</span> <span class="k">with</span> <span class="mi">32</span> <span class="n">cores</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Prediction q_colors&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">,</span> <span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span> <span class="s1">&#39;#8c564b&#39;</span><span class="p">,</span> <span class="s1">&#39;#e377c2&#39;</span><span class="p">,</span> <span class="s1">&#39;#bcbd22&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="s1">&#39;Prediction q&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="n">storing</span> <span class="s1">&#39;Prediction q&#39;</span> <span class="k">as</span> <span class="n">categorical</span>
</pre></div>
</div>
<img alt="../_images/output_93_1.png" src="../_images/output_93_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">=</span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;signature_based_classification&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
<span class="n">pbmc3k</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">=</span><span class="n">df</span>

<span class="n">report</span><span class="o">.</span><span class="n">grouped_distributions</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">columns_obs</span><span class="o">=</span><span class="n">filtered_FC_pbmc3k</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">scale_medians</span><span class="o">=</span><span class="s1">&#39;column-wise&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performing</span> <span class="n">Wilcoxon</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">distribution</span> <span class="n">significantly</span> <span class="n">higher</span> <span class="n">than</span> <span class="n">the</span> <span class="n">others</span> <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">Performing</span> <span class="n">Mann</span><span class="o">-</span><span class="n">Whitney</span> <span class="n">U</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">selected</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span> <span class="n">column</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">a</span> <span class="n">cell</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">values</span> <span class="n">are</span> <span class="n">higher</span> <span class="k">with</span> <span class="n">respect</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">other</span> <span class="n">groups</span>  <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_94_1.png" src="../_images/output_94_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">group_composition</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">classification_obs</span><span class="o">=</span><span class="s1">&#39;Prediction q&#39;</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span>
                  <span class="n">columns_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD4 T&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 T&#39;</span><span class="p">,</span> <span class="s1">&#39;NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Mono&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;Platelet&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_95_0.png" src="../_images/output_95_0.png" />
<p>Again, <strong>no major differences have been found</strong>, indicating the
consistency of the signatures. As expected, the clusters with the
highest variability are CD8 T and CD4 T, which, as mentioned before,
have aspecific signatures.</p>
</div>
<div class="section" id="p-value-based-filtering-mode">
<h4>p value-based filtering mode<a class="headerlink" href="#p-value-based-filtering-mode" title="Permalink to this headline"></a></h4>
<p><strong>The most stringent level of classification</strong> is given by p-val mode.
As mentioned before, FC score is obtained by dividing raw signature
scores for the median of scores of n_iter * randomic signatures. <strong>For
each signature, for each cell, a p-value is calculated by counting how
many times random signature values are higher than gene signature one
(all divided by n_inter)</strong>. If p value is higher than the set p
parameter, the FC score of that cell for that signature will become 0.
In this way <strong>only the significantly signature-expressing cells will be
assigned</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">investigate</span><span class="o">.</span><span class="n">signature_based_classification</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">signatures_dict</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">negative_markers</span><span class="o">=</span><span class="n">neg</span><span class="p">,</span>
                    <span class="n">n_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">obs_name</span><span class="o">=</span><span class="s1">&#39;Prediction p-val&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">new_score</span><span class="o">=</span><span class="s1">&#39;FC&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="mi">14</span><span class="o">/</span><span class="mi">115</span> <span class="n">of</span> <span class="s2">&quot;B&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">3</span><span class="o">/</span><span class="mi">43</span> <span class="n">of</span> <span class="s2">&quot;CD4 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">2</span><span class="o">/</span><span class="mi">22</span> <span class="n">of</span> <span class="s2">&quot;CD8 T&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">5</span><span class="o">/</span><span class="mi">156</span> <span class="n">of</span> <span class="s2">&quot;DC&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">25</span><span class="o">/</span><span class="mi">674</span> <span class="n">of</span> <span class="s2">&quot;Mono&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">4</span><span class="o">/</span><span class="mi">130</span> <span class="n">of</span> <span class="s2">&quot;NK&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>
<span class="mi">9</span><span class="o">/</span><span class="mi">132</span> <span class="n">of</span> <span class="s2">&quot;Platelet&quot;</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">were</span> <span class="n">removed</span> <span class="n">since</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">raw</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;B&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD8 T&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;DC&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Mono&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;NK&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;Platelet&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>

<span class="n">raw</span> <span class="n">scores</span> <span class="n">are</span> <span class="n">being</span> <span class="n">replaced</span> <span class="n">by</span> <span class="n">Fold</span> <span class="n">Change</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="n">Checking</span> <span class="k">for</span> <span class="n">genes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span> <span class="o">...</span>

<span class="n">All</span> <span class="n">signature</span> <span class="n">genes</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">var_names</span>

<span class="n">Computing</span> <span class="n">scaled</span> <span class="n">signature</span> <span class="n">scores</span> <span class="o">...</span>

<span class="s2">&quot;CD8 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>
<span class="s2">&quot;CD4 T_negative&quot;</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">Anndata</span><span class="o">.</span><span class="n">obs</span>

<span class="n">Classification</span> <span class="n">labels</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Prediction p-val&quot;</span><span class="p">]</span>

<span class="n">Results</span> <span class="n">have</span> <span class="n">been</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;signature_based_classification&quot;</span><span class="p">]</span>

<span class="n">Runtime</span> <span class="n">of</span> <span class="n">the</span> <span class="n">process</span> <span class="ow">is</span> <span class="mf">6.44</span> <span class="nb">min</span> <span class="k">with</span> <span class="mi">32</span> <span class="n">cores</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Prediction p-val_colors&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span><span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span><span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span><span class="s1">&#39;#d62728&#39;</span><span class="p">,</span><span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span><span class="s1">&#39;#8c564b&#39;</span><span class="p">,</span><span class="s1">&#39;#e377c2&#39;</span><span class="p">,</span><span class="s1">&#39;#bcbd22&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span><span class="s1">&#39;Prediction p-val&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="n">storing</span> <span class="s1">&#39;Prediction p-val&#39;</span> <span class="k">as</span> <span class="n">categorical</span>
</pre></div>
</div>
<img alt="../_images/output_101_1.png" src="../_images/output_101_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">filtered_FC_pbmc3k</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_102_0.png" src="../_images/output_102_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">=</span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;signature_based_classification&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">pbmc3k</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
<span class="n">pbmc3k</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">=</span><span class="n">df</span>

<span class="n">report</span><span class="o">.</span><span class="n">grouped_distributions</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">columns_obs</span><span class="o">=</span><span class="n">filtered_FC_pbmc3k</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">scale_medians</span><span class="o">=</span><span class="s1">&#39;column-wise&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performing</span> <span class="n">Wilcoxon</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">cell</span> <span class="n">group</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">distribution</span> <span class="n">significantly</span> <span class="n">higher</span> <span class="n">than</span> <span class="n">the</span> <span class="n">others</span> <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">Performing</span> <span class="n">Mann</span><span class="o">-</span><span class="n">Whitney</span> <span class="n">U</span> <span class="n">test</span> <span class="n">on</span> <span class="n">each</span> <span class="n">selected</span> <span class="n">AnnData</span><span class="o">.</span><span class="n">obs</span> <span class="n">column</span> <span class="o">...</span>
<span class="n">For</span> <span class="n">each</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">a</span> <span class="n">cell</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">values</span> <span class="n">are</span> <span class="n">higher</span> <span class="k">with</span> <span class="n">respect</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">other</span> <span class="n">groups</span>  <span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_103_1.png" src="../_images/output_103_1.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">group_composition</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">classification_obs</span><span class="o">=</span><span class="s1">&#39;Prediction p-val&#39;</span><span class="p">,</span> <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">,</span>
                  <span class="n">columns_order</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CD4 T&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8 T&#39;</span><span class="p">,</span> <span class="s1">&#39;NK&#39;</span><span class="p">,</span> <span class="s1">&#39;Mono&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;Platelet&#39;</span><span class="p">,</span> <span class="s1">&#39;Unassigned&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_104_0.png" src="../_images/output_104_0.png" />
<p>Again, <strong>no major differences were found with the statistically relevant
p value mode</strong>, suggesting the <strong>consistency of our classification
method</strong>.</p>
</div>
</div>
</div>
<div class="section" id="classification-performance-evaluation">
<h2>Classification performance evaluation<a class="headerlink" href="#classification-performance-evaluation" title="Permalink to this headline"></a></h2>
<p>To evaluate classification performances both per grond truth cluster and
overall we exploited respectively grouped_classification_metrics and
classification_metrics functions.</p>
<p>In both functions <strong>cell labels assigned by CIA and the annotation
already present in test datasets are compared</strong> in order to count true
positive (TP), true negative (TN), false positive (FP) and false
negative (FN) cells for each cluster. Only for the overall calculation
the per-cluster counts are summed to obtain the total TN, TP, FN and FP.</p>
<p>Then, again for both functions, the following metriacs are calculated: -
<strong>Sensitivity</strong> (SE)= TP/(TP+FN) - <strong>Specificity</strong> (SP)= TN/(TN+FP) -
<strong>Precision</strong> (PR)= TP/(TP+FP) - <strong>Accuracy</strong> (ACC)=
(TN+TP)/(TN+TP+FN+FP) - <strong>F1-score</strong> (F1)= 2<em>TP/(2</em>TP+FN+FP)</p>
<p>N.B.: the column of the classification of interest and the one with
ground truth labels must have the same categories to be compared.</p>
<p>Here, for clarity, we show only the <strong>per-cluster classification</strong>
metrics of the statistically relevant <strong>p value-based method</strong> for both
datasets.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">grouped_classification_metrics</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span> <span class="n">classification_obs</span><span class="o">=</span><span class="s1">&#39;Prediction p-val&#39;</span><span class="p">,</span><span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SE</th>
      <th>SP</th>
      <th>PR</th>
      <th>ACC</th>
      <th>F1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CD4 T</th>
      <td>0.739510</td>
      <td>0.983936</td>
      <td>0.972414</td>
      <td>0.877938</td>
      <td>0.840119</td>
    </tr>
    <tr>
      <th>B</th>
      <td>0.994152</td>
      <td>0.995209</td>
      <td>0.968661</td>
      <td>0.995072</td>
      <td>0.981241</td>
    </tr>
    <tr>
      <th>CD8 T</th>
      <td>0.731013</td>
      <td>0.924203</td>
      <td>0.567568</td>
      <td>0.901061</td>
      <td>0.639004</td>
    </tr>
    <tr>
      <th>NK</th>
      <td>0.980519</td>
      <td>0.976248</td>
      <td>0.719048</td>
      <td>0.976497</td>
      <td>0.829670</td>
    </tr>
    <tr>
      <th>Mono</th>
      <td>0.973016</td>
      <td>0.996016</td>
      <td>0.987118</td>
      <td>0.990523</td>
      <td>0.980016</td>
    </tr>
    <tr>
      <th>DC</th>
      <td>0.945946</td>
      <td>0.993464</td>
      <td>0.673077</td>
      <td>0.992798</td>
      <td>0.786517</td>
    </tr>
    <tr>
      <th>Platelet</th>
      <td>0.933333</td>
      <td>0.990088</td>
      <td>0.350000</td>
      <td>0.989765</td>
      <td>0.509091</td>
    </tr>
  </tbody>
</table>
</div><p>And here are reported the <strong>overall perfomances of each classification
modality</strong>:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">classification_metrics</span><span class="p">(</span><span class="n">pbmc3k</span><span class="p">,</span>
                       <span class="n">classification_obs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Prediction fast mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Prediction standard mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Prediction q&#39;</span><span class="p">,</span> <span class="s1">&#39;Prediction p-val&#39;</span><span class="p">],</span>
                       <span class="n">groups_obs</span><span class="o">=</span><span class="s1">&#39;Cell type&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SE</th>
      <th>SP</th>
      <th>PR</th>
      <th>ACC</th>
      <th>F1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Prediction fast mode</th>
      <td>0.895375</td>
      <td>0.982563</td>
      <td>0.895375</td>
      <td>0.970107</td>
      <td>0.895375</td>
    </tr>
    <tr>
      <th>Prediction standard mode</th>
      <td>0.863912</td>
      <td>0.977319</td>
      <td>0.863912</td>
      <td>0.961118</td>
      <td>0.863912</td>
    </tr>
    <tr>
      <th>Prediction q</th>
      <td>0.866566</td>
      <td>0.978014</td>
      <td>0.867882</td>
      <td>0.962092</td>
      <td>0.867223</td>
    </tr>
    <tr>
      <th>Prediction p-val</th>
      <td>0.845337</td>
      <td>0.979719</td>
      <td>0.874167</td>
      <td>0.960522</td>
      <td>0.859511</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline"></a></h2>
<p><strong>Signature score</strong> is confirmed to be a powerful way to <strong>condensate
the information of a whole gene signature expression</strong> at single cell
level. The <strong>only differenceres</strong> from the expected score distributions
were <strong>attributed to the high transcriptional similarity</strong> (reported by
the authors themselves) <strong>of some PBMC atlas cell group</strong> (from which we
extracted the signatures), which have been previously defined also
exploiting protein level information. This further suggested the
<strong>capability of this score to clearly highlight the goodness of the
transcriptional signature</strong> itself.</p>
<p><strong>Signature based classification</strong> resulted to be <strong>effective in the
automatic annotation</strong> of scRNA-seq datasets with external signatures.
In particular, considering the overall performances of CIA in the PBMC3K
test dataset:</p>
<ul class="simple">
<li><p>our method is able to <strong>rapidly classify a scRNA-seq dataset</strong> using
independent gene signatures and known negative markers <strong>without any
clustering step</strong>.</p></li>
<li><p><strong>all the shown classification modalities</strong> annotated cells with
<strong>good performances</strong> (lowest ACC: 96.03%, lowest F1:85.90%),
suggesting that <strong>fast classification can be used as explorative
analysis to infer cell idendity</strong> before a run with the more
computationally intense FC-based mode.</p></li>
</ul>
<p>In our package, besides the classification tool, we also implemented a
<strong>module of functions</strong> which allow to <strong>easily compare classification
methods</strong> and <strong>evaluate score distributions</strong> in cell groups (also
obtained with other packages).</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../modules_modified.html" class="btn btn-neutral float-left" title="cia package" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../license.html" class="btn btn-neutral float-right" title="License" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, National Institue of Molecular Genetics (INGM).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>